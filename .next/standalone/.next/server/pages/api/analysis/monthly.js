"use strict";(()=>{var t={};t.id=447,t.ids=[447],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:t=>{t.exports=import("@supabase/supabase-js")},9926:t=>{t.exports=import("zod")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},2058:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.r(e),r.d(e,{config:()=>c,default:()=>_,routeModule:()=>d});var a=r(1802),n=r(7153),i=r(6249),o=r(7759),l=t([o]);o=(l.then?(await l)():l)[0];let _=(0,i.l)(o,"default"),c=(0,i.l)(o,"config"),d=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/analysis/monthly",pathname:"/api/analysis/monthly",bundlePath:"",filename:""},userland:o});s()}catch(t){s(t)}})},8159:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.d(e,{O:()=>o});var a=r(9926),n=t([a]);let i=(a=(n.then?(await n)():n)[0]).z.object({KALSHI_API_ID:a.z.string().min(1),KALSHI_PRIVATE_KEY:a.z.string().min(1),VERCEL_AI_GATEWAY_KEY:a.z.string().min(1).optional(),AI_GATEWAY_API_KEY:a.z.string().min(1).optional(),VERCEL_OIDC_TOKEN:a.z.string().min(1).optional(),SUPABASE_URL:a.z.string().url(),SUPABASE_KEY:a.z.string().min(1).optional(),SUPABASE_SERVICE_ROLE_KEY:a.z.string().min(1).optional(),CRON_SECRET:a.z.string().min(1),DAILY_BUDGET:a.z.string().transform(Number).default("100"),MIN_ODDS:a.z.string().transform(Number).default("0.85"),MAX_ODDS:a.z.string().transform(Number).default("0.98"),MAX_DAYS_TO_RESOLUTION:a.z.string().transform(Number).default("2"),MIN_LIQUIDITY:a.z.string().transform(Number).default("2000"),DRY_RUN:a.z.string().transform(t=>"true"===t).default("false"),INITIAL_BANKROLL:a.z.string().transform(Number).default("1000")}),o=function(){try{let t=i.parse(process.env),e=t.SUPABASE_KEY||t.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("Missing SUPABASE_KEY (or SUPABASE_SERVICE_ROLE_KEY)");let r=t.VERCEL_AI_GATEWAY_KEY||t.AI_GATEWAY_API_KEY||t.VERCEL_OIDC_TOKEN;if(!r)throw Error("Missing VERCEL_AI_GATEWAY_KEY (or AI_GATEWAY_API_KEY / VERCEL_OIDC_TOKEN)");return{...t,SUPABASE_KEY:e,VERCEL_AI_GATEWAY_KEY:r}}catch(t){if(t instanceof a.z.ZodError){let e=t.errors.map(t=>t.path.join(".")).join(", ");throw Error(`Missing or invalid environment variables: ${e}`)}throw t}}();s()}catch(t){s(t)}})},3288:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.d(e,{B3:()=>o,ce:()=>c,eH:()=>l,zF:()=>_});var a=r(8231),n=r(3435),i=t([a,n]);async function o(t,e){let r=new Date(t,e-1,1),s=new Date(t,e,0,23,59,59),a=String(e).padStart(2,"0");console.log(`ðŸ“Š Generating monthly analysis for ${t}-${a}...`);let i=(await (0,n.Pq)(r,s)).filter(t=>"open"!==t.status&&null!==t.pnl);if(0===i.length)return{month_year:r,total_trades:0,total_invested:0,total_pnl:0,win_rate:0,avg_roi:0,market_type_analysis:{},series_analysis:{},top_market_types:[],top_series_ids:[],worst_market_types:[],worst_series_ids:[],insights:"No resolved trades for this month."};let o={},l={};for(let t of i){let e=function(t,e){if(e)return e;let r=t.toLowerCase();return r.includes("election")||r.includes("vote")||r.includes("candidate")?"Elections/Politics":r.includes("sport")||r.includes("game")||r.includes("match")||r.includes("nfl")||r.includes("nba")||r.includes("mlb")||r.includes("football")||r.includes("basketball")||r.includes("baseball")?"Sports":r.includes("earnings")||r.includes("stock")||r.includes("market")?"Finance/Earnings":r.includes("data")||r.includes("release")||r.includes("report")?"Data Releases":r.includes("deadline")||r.includes("date")||r.includes("by")?"Time-based":r.includes("approval")||r.includes("approve")||r.includes("regulatory")?"Regulatory/Approval":"Other"}(t.contract?.question||"",t.contract?.category),r=function(t){let e=t.split("-");return e.length>=2?e.slice(0,2).join("-"):e[0]||t}(t.contract?.market_id||"");o[e]||(o[e]={trades:0,total_invested:0,total_pnl:0,wins:0,losses:0,win_rate:0,avg_roi:0}),l[r]||(l[r]={trades:0,total_invested:0,total_pnl:0,wins:0,losses:0,win_rate:0,avg_roi:0});let s=t.position_size||0,a=t.pnl||0;o[e].trades++,o[e].total_invested+=s,o[e].total_pnl+=a,"won"===t.status?o[e].wins++:o[e].losses++,l[r].trades++,l[r].total_invested+=s,l[r].total_pnl+=a,"won"===t.status?l[r].wins++:l[r].losses++}let _=t=>{t.win_rate=t.trades>0?t.wins/t.trades:0,t.avg_roi=t.total_invested>0?t.total_pnl/t.total_invested*100:0};Object.values(o).forEach(_),Object.values(l).forEach(_);let c=i.reduce((t,e)=>t+(e.position_size||0),0),d=i.reduce((t,e)=>t+(e.pnl||0),0),u=i.filter(t=>"won"===t.status).length,p=i.length>0?u/i.length:0,m=Object.entries(o).map(([t,e])=>({type:t,roi:e.avg_roi,stats:e})).filter(t=>t.stats.trades>=3),y=Object.entries(l).map(([t,e])=>({series_id:t,roi:e.avg_roi,stats:e})).filter(t=>t.stats.trades>=2),f=m.sort((t,e)=>e.roi-t.roi).slice(0,5).map(t=>({type:t.type,roi:t.roi})),g=m.sort((t,e)=>t.roi-e.roi).slice(0,3).map(t=>({type:t.type,roi:t.roi})),h=y.sort((t,e)=>e.roi-t.roi).slice(0,5).map(t=>({series_id:t.series_id,roi:t.roi})),w=y.sort((t,e)=>t.roi-e.roi).slice(0,3).map(t=>({series_id:t.series_id,roi:t.roi})),E=function(t,e,r,s){let a=[];r.length>0&&a.push(`Best performing market types: ${r.map(t=>`${t.type} (${t.roi.toFixed(1)}% ROI)`).join(", ")}`),s.length>0&&a.push(`Underperforming market types: ${s.map(t=>`${t.type} (${t.roi.toFixed(1)}% ROI)`).join(", ")}`);let n=t.Sports;n&&n.trades>=5&&a.push(`Sports markets: ${n.trades} trades, ${(100*n.win_rate).toFixed(1)}% win rate, ${n.avg_roi.toFixed(1)}% ROI`);let i=t["Elections/Politics"];return(i&&i.trades>=5&&a.push(`Political markets: ${i.trades} trades, ${(100*i.win_rate).toFixed(1)}% win rate, ${i.avg_roi.toFixed(1)}% ROI`),0===a.length)?"Insufficient data for meaningful insights this month.":a.join(". ")+"."}(o,0,f,g);return{month_year:r,total_trades:i.length,total_invested:c,total_pnl:d,win_rate:p,avg_roi:c>0?d/c*100:0,market_type_analysis:o,series_analysis:l,top_market_types:f,top_series_ids:h,worst_market_types:g,worst_series_ids:w,insights:E}}async function l(t){let e=t.month_year.getFullYear(),r=String(t.month_year.getMonth()+1).padStart(2,"0"),s=`${e}-${r}-01`,{error:n}=await a.O.from("monthly_analysis").upsert({month_year:s,total_trades:t.total_trades,total_invested:t.total_invested,total_pnl:t.total_pnl,win_rate:t.win_rate,avg_roi:t.avg_roi,market_type_analysis:t.market_type_analysis,series_analysis:t.series_analysis,top_market_types:t.top_market_types,top_series_ids:t.top_series_ids,worst_market_types:t.worst_market_types,worst_series_ids:t.worst_series_ids,insights:t.insights,updated_at:new Date().toISOString()},{onConflict:"month_year"});if(n)throw Error(`Failed to save monthly analysis: ${n.message}`);console.log(`âœ… Saved monthly analysis for ${s}`)}async function _(t,e){let r=String(e).padStart(2,"0"),s=`${t}-${r}-01`,{data:n,error:i}=await a.O.from("monthly_analysis").select("*").eq("month_year",s).single();if(i){if("PGRST116"===i.code)return null;if("PGRST205"===i.code||i.message?.includes("not found"))return console.warn("âš ï¸ monthly_analysis table not found. Run migrations."),null;throw i}return n?{month_year:new Date(n.month_year),total_trades:n.total_trades,total_invested:parseFloat(n.total_invested?.toString()||"0"),total_pnl:parseFloat(n.total_pnl?.toString()||"0"),win_rate:parseFloat(n.win_rate?.toString()||"0"),avg_roi:parseFloat(n.avg_roi?.toString()||"0"),market_type_analysis:n.market_type_analysis||{},series_analysis:n.series_analysis||{},top_market_types:n.top_market_types||[],top_series_ids:n.top_series_ids||[],worst_market_types:n.worst_market_types||[],worst_series_ids:n.worst_series_ids||[],insights:n.insights||""}:null}async function c(){let{data:t,error:e}=await a.O.from("monthly_analysis").select("*").order("month_year",{ascending:!1});if(e){if("PGRST205"===e.code||e.message?.includes("not found"))return console.warn("âš ï¸ monthly_analysis table not found. Run migrations."),[];throw e}return t?t.map(t=>({month_year:new Date(t.month_year),total_trades:t.total_trades,total_invested:parseFloat(t.total_invested?.toString()||"0"),total_pnl:parseFloat(t.total_pnl?.toString()||"0"),win_rate:parseFloat(t.win_rate?.toString()||"0"),avg_roi:parseFloat(t.avg_roi?.toString()||"0"),market_type_analysis:t.market_type_analysis||{},series_analysis:t.series_analysis||{},top_market_types:t.top_market_types||[],top_series_ids:t.top_series_ids||[],worst_market_types:t.worst_market_types||[],worst_series_ids:t.worst_series_ids||[],insights:t.insights||""})):[]}[a,n]=i.then?(await i)():i,s()}catch(t){s(t)}})},8231:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.d(e,{O:()=>o});var a=r(1309),n=r(8159),i=t([a,n]);[a,n]=i.then?(await i)():i;let o=(0,a.createClient)(n.O.SUPABASE_URL,n.O.SUPABASE_KEY);s()}catch(t){s(t)}})},3435:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.d(e,{$r:()=>l,FC:()=>m,Jg:()=>d,Of:()=>f,Pq:()=>_,Xb:()=>c,Xx:()=>y,dY:()=>p,fT:()=>g,lv:()=>o,mo:()=>i,sl:()=>u,zC:()=>h});var a=r(8231),n=t([a]);async function i(){let{data:t,error:e}=await a.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).eq("status","open").order("executed_at",{ascending:!1});if(e)throw e;return t}async function o(t=50){let{data:e,error:r}=await a.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).order("executed_at",{ascending:!1}).limit(t);if(r)throw r;return e}async function l(){let t=new Date;t.setHours(0,0,0,0);let{data:e,error:r}=await a.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).gte("executed_at",t.toISOString()).order("executed_at",{ascending:!1});if(r)throw r;return e}async function _(t,e){let{data:r,error:s}=await a.O.from("trades").select(`
      *,
      contract:contracts(*)
    `).gte("executed_at",t.toISOString()).lte("executed_at",e.toISOString()).order("executed_at",{ascending:!1});if(s)throw s;return r}async function c(t){let{data:e,error:r}=await a.O.from("trades").insert({...t,status:"open",executed_at:new Date().toISOString()}).select(`
      *,
      contract:contracts(*)
    `).single();if(r)throw r;return e}async function d(t,e){let{data:r,error:s}=await a.O.from("trades").update(e).eq("id",t).select(`
      *,
      contract:contracts(*)
    `).single();if(s)throw s;return r}async function u(){return(await i()).map(t=>({trade:t,current_odds:t.entry_odds,unrealized_pnl:0,unrealized_pnl_pct:0}))}async function p(){let{data:t}=await a.O.from("performance_metrics").select("bankroll").order("date",{ascending:!1}).limit(1).single();return t?.bankroll||Number(process.env.INITIAL_BANKROLL)||1e3}async function m(){return Number(process.env.INITIAL_BANKROLL)||1e3}async function y(t){let{data:e}=await a.O.from("performance_metrics").select("bankroll").lte("date",t.toISOString()).order("date",{ascending:!1}).limit(1).single();return e?.bankroll||Number(process.env.INITIAL_BANKROLL)||1e3}async function f(){let t=await p(),e=(await u()).reduce((t,e)=>t+e.trade.position_size,0);return t-e}async function g(){let{data:t,error:e}=await a.O.from("notification_preferences").select("*").eq("user_id","default").single();if(e&&"PGRST116"!==e.code)throw e;return t||{enabled:!1}}async function h(t){let e=new Date(Date.now()-36e5*t),{data:r,error:s}=await a.O.from("stop_loss_events").select(`
      *,
      trade:trades(
        *,
        contract:contracts(*)
      )
    `).gte("executed_at",e.toISOString()).order("executed_at",{ascending:!1});if(s)throw s;return r}a=(n.then?(await n)():n)[0],s()}catch(t){s(t)}})},7759:(t,e,r)=>{r.a(t,async(t,s)=>{try{r.r(e),r.d(e,{default:()=>i});var a=r(3288),n=t([a]);async function i(t,e){if("GET"!==t.method)return e.status(405).json({error:"Method not allowed"});try{if(t.query.year&&t.query.month){let r=parseInt(t.query.year),s=parseInt(t.query.month),n=await (0,a.zF)(r,s);if(!n)return e.status(404).json({error:"Analysis not found for this month"});return e.status(200).json(n)}let r=await (0,a.ce)();return e.status(200).json({analyses:r})}catch(t){return console.error("Error fetching monthly analysis:",t),e.status(500).json({error:t.message})}}a=(n.then?(await n)():n)[0],s()}catch(t){s(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var r=e(e.s=2058);module.exports=r})();