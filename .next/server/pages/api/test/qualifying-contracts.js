"use strict";(()=>{var e={};e.id=719,e.ids=[719],e.modules={358:e=>{e.exports=require("kalshi-typescript")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},9926:e=>{e.exports=import("zod")},6494:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{config:()=>c,default:()=>l,routeModule:()=>u});var s=o(1802),a=o(7153),i=o(6249),n=o(2950),d=e([n]);n=(d.then?(await d)():d)[0];let l=(0,i.l)(n,"default"),c=(0,i.l)(n,"config"),u=new s.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/test/qualifying-contracts",pathname:"/api/test/qualifying-contracts",bundlePath:"",filename:""},userland:n});r()}catch(e){r(e)}})},3365:(e,t,o)=>{o.d(t,{U:()=>r});let r={DAILY_BUDGET:Number(process.env.DAILY_BUDGET)||100,MIN_ODDS:Number(process.env.MIN_ODDS)||.85,MAX_ODDS:Number(process.env.MAX_ODDS)||.98,MAX_DAYS_TO_RESOLUTION:Number(process.env.MAX_DAYS_TO_RESOLUTION)||2,MIN_LIQUIDITY:Number(process.env.MIN_LIQUIDITY)||2e3,INITIAL_BANKROLL:Number(process.env.INITIAL_BANKROLL)||100,DRY_RUN:"true"===process.env.DRY_RUN,MIN_POSITION_SIZE:20,MAX_POSITION_SIZE:50,STOP_LOSS_THRESHOLD:.8,MIN_HOLD_TIME_HOURS:1,MAX_SLIPPAGE_PCT:.05,MAX_LOSSES_IN_STREAK:5,MAX_STOP_LOSSES_24H:3,BANKROLL_DROP_THRESHOLD:.7,EXCLUDE_CATEGORIES:[],EXCLUDE_KEYWORDS:[]}},8231:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.d(t,{O:()=>n});var s=o(1309),a=o(8159),i=e([s,a]);[s,a]=i.then?(await i)():i;let n=(0,s.createClient)(a.O.SUPABASE_URL,a.O.SUPABASE_KEY);r()}catch(e){r(e)}})},5526:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.d(t,{A0:()=>l,US:()=>n});var s=o(8231),a=o(913),i=e([s,a]);async function n(){let e=new Date(Date.now()-72e5),{data:t,error:o}=await s.O.from("contracts").select("*").gte("discovered_at",e.toISOString()).eq("resolved",!1).order("discovered_at",{ascending:!1});return o?(console.error("Error fetching cached markets:",o),[]):t&&0!==t.length?t.map(e=>({market_id:e.market_id,question:e.question,end_date:new Date(e.end_date),yes_odds:parseFloat(e.current_odds.toString()),no_odds:1-parseFloat(e.current_odds.toString()),liquidity:parseFloat(e.liquidity?.toString()||"0"),volume_24h:parseFloat(e.volume_24h?.toString()||"0"),resolved:e.resolved||!1,category:e.category||void 0,outcome:e.outcome||void 0,final_odds:e.final_odds?parseFloat(e.final_odds.toString()):void 0,resolved_at:e.resolved_at?new Date(e.resolved_at):void 0})):[]}async function d(e){if(0===e.length)return;console.log(`üíæ Caching ${e.length} markets to database...`);let t=e.map(e=>({market_id:e.market_id,question:e.question,end_date:e.end_date.toISOString(),current_odds:e.yes_odds,category:e.category||null,liquidity:e.liquidity||0,volume_24h:e.volume_24h||0,resolved:e.resolved||!1,outcome:e.outcome||null,final_odds:e.final_odds||null,resolved_at:e.resolved_at?.toISOString()||null,discovered_at:new Date().toISOString()}));for(let e=0;e<t.length;e+=100){let o=t.slice(e,e+100),{error:r}=await s.O.from("contracts").upsert(o,{onConflict:"market_id",ignoreDuplicates:!1});r?console.error(`Error caching markets chunk ${e/100+1}:`,r):console.log(`   ‚úÖ Cached chunk ${e/100+1}/${Math.ceil(t.length/100)} (${o.length} markets)`)}console.log(`‚úÖ Cached ${e.length} markets successfully`)}async function l(e){console.log("\uD83D\uDD04 Refreshing market page...",e?`(cursor: ${e.substring(0,20)}...)`:"(first page)");let t=(0,a.DZ)();try{let o=await t.getMarkets(100,e||void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,"open",void 0,void 0),r=o.data.markets||[],s=o.data.cursor||null,i=r.map(e=>{let t;let o=(0,a.TN)(e);try{let o=e.expected_expiration_time||e.expiration_time||e.expirationTime||e.close_time||e.end_date;t=new Date(o),isNaN(t.getTime())&&(t=new Date(Date.now()+6048e5))}catch(e){t=new Date(Date.now()+6048e5)}let r="closed"===e.status||"settled"===e.status||"resolved"===e.status,s="yes"===e.result?"YES":"no"===e.result?"NO":void 0;return{market_id:e.ticker||e.market_id||e.id,question:e.title||e.question||e.subtitle||e.yes_sub_title||"N/A",end_date:t,yes_odds:null!==o?o/100:0,no_odds:null!==o?(100-o)/100:0,liquidity:0,volume_24h:parseFloat(e.volume_24h||e.volume||0),resolved:r,category:e.category||e.event_ticker||void 0,outcome:s,final_odds:e.last_price?parseFloat(e.last_price.toString())/100:void 0,resolved_at:e.close_time?new Date(e.close_time):void 0}});return await d(i),console.log(`   ‚úÖ Cached ${i.length} markets. Next cursor: ${s?"yes":"no"}`),{markets:i,nextCursor:s,isComplete:!s||0===r.length}}catch(o){if(o.response?.status===429){let e=o.response.headers["retry-after"],t=e?1e3*parseInt(e):5e3;throw Error(`Rate limited. Wait ${t}ms`)}if(o.message?.startsWith("RATE_LIMITED:")){let e=parseInt(o.message.split(":")[1]);throw Error(`Rate limited. Wait ${e}ms`)}let e=o.response?.data?.error?.message||o.message||"Unknown error",t=o.response?.status||500;throw Error(`Kalshi API error: ${t} - ${e}`)}}[s,a]=i.then?(await i)():i,r()}catch(e){r(e)}})},7372:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.d(t,{w:()=>d});var s=o(913),a=o(5526),i=o(3365),n=e([s,a]);async function d(e={minOdds:i.U.MIN_ODDS,maxOdds:i.U.MAX_ODDS,maxDaysToResolution:i.U.MAX_DAYS_TO_RESOLUTION,minLiquidity:i.U.MIN_LIQUIDITY,excludeCategories:i.U.EXCLUDE_CATEGORIES,excludeKeywords:i.U.EXCLUDE_KEYWORDS}){console.log("\uD83D\uDD0D Scanning Kalshi for high-conviction contracts..."),console.log(`   Criteria: ${100*e.minOdds}%-${100*e.maxOdds}% odds, <${e.maxDaysToResolution} days, >$${e.minLiquidity} liquidity`);let t=await (0,a.US)();if(console.log(`   ‚úÖ Retrieved ${t.length} markets from cache`),0===t.length)return console.warn("‚ö†Ô∏è No cached markets found. Market refresh cron may not have run yet."),[];let o=[];for(let r of t){if(!r.yes_odds||0===r.yes_odds||null===r.yes_odds)continue;let t=100*r.yes_odds,a=t>=100*e.minOdds,i=t<=(1-e.maxOdds)*100;if(!a&&!i)continue;let n=(0,s.YI)(r.end_date);if(n>e.maxDaysToResolution||n<0||r.resolved||r.category&&e.excludeCategories?.includes(r.category))continue;let d=r.question.toLowerCase();(e.excludeKeywords||[]).map(e=>e.toLowerCase()).some(e=>d.includes(e))||o.push(r)}console.log(`   üìä Found ${o.length} high-conviction candidates after filtering`);let r=[],n=[];for(let t=0;t<o.length;t++){let a=o[t];try{let{liquidity:i,side:n}=await (0,s.Z9)(a.market_id);if(i<e.minLiquidity)continue;let d={id:"",market_id:a.market_id,question:a.question,end_date:a.end_date,current_odds:a.yes_odds,liquidity:i,volume_24h:a.volume_24h,category:a.category,discovered_at:new Date};r.push(d),((t+1)%10==0||t+1===o.length)&&console.log(`   üìà Enriched ${t+1}/${o.length} candidates... (${r.length} passed liquidity filter)`)}catch(e){n.push(`${a.market_id}: ${e.message}`);continue}}return n.length>0&&(console.warn(`   ‚ö†Ô∏è ${n.length} markets failed enrichment (likely resolved or inactive)`),n.length<=5&&n.forEach(e=>console.warn(`      ${e}`))),r.sort((e,t)=>(t.liquidity||0)-(e.liquidity||0)),console.log(`   ‚úÖ Found ${r.length} qualifying contracts with sufficient liquidity`),r}[s,a]=n.then?(await n)():n,r()}catch(e){r(e)}})},2950:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{default:()=>l});var s=o(7372),a=o(5526),i=o(913),n=o(3365),d=e([s,a,i]);async function l(e,t){if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return t.status(401).json({error:"Unauthorized"});try{let e={timestamp:new Date().toISOString(),criteria:{minOdds:n.U.MIN_ODDS,maxOdds:n.U.MAX_ODDS,maxDaysToResolution:n.U.MAX_DAYS_TO_RESOLUTION,minLiquidity:n.U.MIN_LIQUIDITY,excludeCategories:n.U.EXCLUDE_CATEGORIES,excludeKeywords:n.U.EXCLUDE_KEYWORDS},stages:{}},o=await (0,a.US)();if(e.stages.cached_markets={count:o.length,sample:o.slice(0,3).map(e=>({market_id:e.market_id,question:e.question.substring(0,80),yes_odds:e.yes_odds,end_date:e.end_date}))},0===o.length)return t.status(200).json({...e,summary:{qualifying_count:0,message:"No cached markets found. Market refresh cron may need to run."}});let r=o.filter(e=>{if(!e.yes_odds||0===e.yes_odds||null===e.yes_odds)return!1;let t=100*e.yes_odds,o=t>=100*n.U.MIN_ODDS,r=t<=(1-n.U.MAX_ODDS)*100;if(!o&&!r)return!1;let s=(0,i.YI)(e.end_date);if(s>n.U.MAX_DAYS_TO_RESOLUTION||s<0||e.resolved||e.category&&n.U.EXCLUDE_CATEGORIES.length>0&&n.U.EXCLUDE_CATEGORIES.includes(e.category))return!1;if(n.U.EXCLUDE_KEYWORDS.length>0){let t=n.U.EXCLUDE_KEYWORDS,o=e.question.toLowerCase();if(t.some(e=>o.includes(e.toLowerCase())))return!1}return!0});e.stages.after_filtering={count:r.length,filtered_out:o.length-r.length,sample:r.slice(0,5).map(e=>({market_id:e.market_id,question:e.question.substring(0,80),yes_odds:e.yes_odds,yes_price_cents:Math.round(100*e.yes_odds),days_to_resolution:(0,i.YI)(e.end_date),category:e.category}))},console.log("\uD83D\uDD0D Running full scan with liquidity checks...");let d=await (0,s.w)();e.stages.after_liquidity_check={count:d.length,filtered_out:r.length-d.length,sample:d.slice(0,5).map(e=>({market_id:e.market_id,question:e.question.substring(0,80),current_odds:e.current_odds,odds_percent:Math.round(100*e.current_odds),liquidity:e.liquidity,days_to_resolution:(0,i.YI)(e.end_date),category:e.category}))};let l={high_yes:d.filter(e=>e.current_odds>=n.U.MIN_ODDS).length,high_no:d.filter(e=>e.current_odds<=1-n.U.MAX_ODDS).length},c={today:d.filter(e=>1>(0,i.YI)(e.end_date)).length,tomorrow:d.filter(e=>{let t=(0,i.YI)(e.end_date);return t>=1&&t<2}).length,two_days:d.filter(e=>{let t=(0,i.YI)(e.end_date);return t>=2&&t<=n.U.MAX_DAYS_TO_RESOLUTION}).length};return e.summary={qualifying_count:d.length,breakdown_by_odds:l,breakdown_by_days:c,message:d.length>0?`Found ${d.length} qualifying contracts meeting all criteria`:"No qualifying contracts found. All contracts were filtered out at one or more stages.",stages_completed:["Cached markets retrieved","Odds and resolution time filtered","Liquidity checked via orderbook"]},t.status(200).json(e)}catch(e){return console.error("Qualifying contracts test error:",e),t.status(500).json({error:e.message,details:void 0})}}[s,a,i]=d.then?(await d)():d,r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[947],()=>o(6494));module.exports=r})();